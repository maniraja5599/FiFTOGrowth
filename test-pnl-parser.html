<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&L Parser Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            background: #0d4f3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0a3d2e;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .result-item {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Flattrade P&L Parser Test Tool</h1>
    
    <div class="test-section">
        <h2>Step 1: Get HTML from Flattrade Page</h2>
        <p>1. Open <a href="https://wall.flattrade.in/pnl/PO48d06e2272034b9e85d476c7fbd58057" target="_blank">Flattrade P&L Page</a></p>
        <p>2. Right-click → View Page Source (or Ctrl+U / Cmd+U)</p>
        <p>3. Copy the HTML and paste it below</p>
        <textarea id="html-input" placeholder="Paste Flattrade page HTML here..."></textarea>
        <button onclick="testParser()">Test Parser</button>
        <button onclick="fetchAndTest()">Fetch & Test (if CORS allows)</button>
    </div>
    
    <div class="test-section">
        <h2>Step 2: Parser Results</h2>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h2>Step 3: Inspect Page Structure</h2>
        <p>If parser doesn't work, inspect the page structure:</p>
        <ol>
            <li>Open Flattrade page in browser</li>
            <li>Right-click on the P&L table → Inspect</li>
            <li>Note the HTML structure (table tags, class names, etc.)</li>
            <li>Share the structure to update the parser</li>
        </ol>
        <div id="structure-info"></div>
    </div>

    <script>
        // Copy the parseFlattradeData function from pnl-tracker.js
        function parseFlattradeData(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const daily = [];
            
            // Try multiple parsing strategies
            const tables = doc.querySelectorAll('table');
            
            tables.forEach(table => {
                const rows = table.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    if (index === 0) return;
                    
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length >= 2) {
                        let dateStr = '';
                        let pnlStr = '';
                        let percentStr = '';
                        
                        cells.forEach((cell, idx) => {
                            const text = cell.textContent.trim();
                            if (text.match(/\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}/) || 
                                text.match(/\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/)) {
                                dateStr = text;
                            }
                            if (text.includes('₹') || (text.match(/[\d,]+\.?\d*/) && !dateStr)) {
                                if (!pnlStr) pnlStr = text;
                                else if (!percentStr) percentStr = text;
                            }
                            if (text.includes('%')) {
                                percentStr = text;
                            }
                        });
                        
                        if (dateStr) {
                            const date = new Date(dateStr);
                            const pnl = parseFloat(pnlStr.replace(/[₹,\s]/g, '')) || 0;
                            const percent = parseFloat(percentStr.replace(/[%,\s]/g, '')) || 0;
                            
                            if (!isNaN(date.getTime())) {
                                daily.push({
                                    date: date.toISOString(),
                                    dateStr: dateStr,
                                    pnl: pnl,
                                    percent: percent,
                                    raw: {
                                        date: dateStr,
                                        pnl: pnlStr,
                                        percent: percentStr
                                    }
                                });
                            }
                        }
                    }
                });
            });
            
            return daily;
        }
        
        function testParser() {
            const html = document.getElementById('html-input').value;
            if (!html) {
                alert('Please paste the HTML first');
                return;
            }
            
            const results = parseFlattradeData(html);
            displayResults(results, html);
        }
        
        async function fetchAndTest() {
            const url = 'https://wall.flattrade.in/pnl/PO48d06e2272034b9e85d476c7fbd58057';
            try {
                const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
                const html = await response.text();
                document.getElementById('html-input').value = html;
                const results = parseFlattradeData(html);
                displayResults(results, html);
            } catch (error) {
                alert('CORS Error: ' + error.message + '\n\nPlease copy HTML manually and paste it.');
            }
        }
        
        function displayResults(results, html) {
            const resultsDiv = document.getElementById('results');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="color: red;">
                        <h3>No data found!</h3>
                        <p>The parser couldn't extract P&L data. This means the HTML structure is different.</p>
                        <p><strong>Next steps:</strong></p>
                        <ol>
                            <li>Inspect the Flattrade page HTML structure</li>
                            <li>Find the table/element containing P&L data</li>
                            <li>Share the structure to update the parser</li>
                        </ol>
                        <h4>HTML Structure Analysis:</h4>
                        <pre>${analyzeHTML(html)}</pre>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div style="color: green;">
                        <h3>Success! Found ${results.length} days of data</h3>
                        <div class="result">
                            ${results.map((item, idx) => `
                                <div class="result-item">
                                    <strong>Day ${idx + 1}:</strong> ${item.dateStr} | 
                                    P&L: ₹${item.pnl.toLocaleString('en-IN')} | 
                                    %: ${item.percent.toFixed(2)}%
                                </div>
                            `).join('')}
                        </div>
                        <h4>JSON Output (for testing):</h4>
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        function analyzeHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const analysis = [];
            
            // Find all tables
            const tables = doc.querySelectorAll('table');
            analysis.push(`Found ${tables.length} table(s)`);
            
            tables.forEach((table, idx) => {
                const rows = table.querySelectorAll('tr');
                analysis.push(`\nTable ${idx + 1}: ${rows.length} rows`);
                
                if (rows.length > 0) {
                    const firstRow = rows[0];
                    const cells = firstRow.querySelectorAll('td, th');
                    analysis.push(`  Header: ${cells.length} columns`);
                    cells.forEach((cell, cidx) => {
                        analysis.push(`    Col ${cidx + 1}: "${cell.textContent.trim()}"`);
                    });
                    
                    if (rows.length > 1) {
                        const secondRow = rows[1];
                        const dataCells = secondRow.querySelectorAll('td');
                        analysis.push(`  Sample row: ${dataCells.length} cells`);
                        dataCells.forEach((cell, cidx) => {
                            analysis.push(`    Cell ${cidx + 1}: "${cell.textContent.trim()}"`);
                        });
                    }
                }
            });
            
            return analysis.join('\n');
        }
    </script>
</body>
</html>

